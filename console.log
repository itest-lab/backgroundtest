try {
    // 1. 画像を取得
    console.log('Fetching image from:', imageUrl);
    const response = await fetch(imageUrl);
    console.log('Image fetch response:', response);

    if (!response.ok) throw new Error('画像の取得に失敗しました');
    const blob = await response.blob();
    const arrayBuffer = await blob.arrayBuffer();
    const base64Image = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
    console.log('Base64 Image:', base64Image);

    // 2. GitHub APIでアップロード
    const fileName = `images/${Date.now()}-${Math.random().toString(36).substring(7)}.png`;
    const githubUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${fileName}`;
    console.log('GitHub API URL:', githubUrl);

    const uploadResponse = await fetch(githubUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: `Add image ${fileName}`,
        content: base64Image,
        branch: BRANCH,
      }),
    });
    console.log('GitHub API response:', uploadResponse);

    if (!uploadResponse.ok) {
      const errorDetails = await uploadResponse.json();
      console.error('GitHub API error details:', errorDetails);
      throw new Error('画像のアップロードに失敗しました');
    }

    const uploadResult = await uploadResponse.json();
    console.log('Upload result:', uploadResult);

    // 3. 背景画像として設定
    const uploadedUrl = uploadResult.content.download_url;
    document.body.style.backgroundImage = `url('${uploadedUrl}')`;
    statusElement.textContent = '画像をアップロードして背景に設定しました!';
} catch (error) {
    console.error('Error occurred:', error);
    statusElement.textContent = `エラー: ${error.message}`;
}
